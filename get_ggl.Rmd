---
title: "Tidy Template"
author: "Fabio Votta"
date: "The Date"
output: html_document
---

This script is about:



## Packages and Folders

```{r}
# Install these packages if you don't have them yet
# if (!require("pacman")) install.packages("pacman")
# devtools::install_github("favstats/tidytemplate")

pacman::p_load(tidyverse, tidytemplate, rvest, data.table, janitor)

# Creates folders
# tidytemplate::data_dir()
# tidytemplate::images_dir()
```


## Load Data

```{r, data}

get_ggl_data <- function() {
  ggl_link <- "https://storage.googleapis.com/transparencyreport/google-political-ads-transparency-bundle.zip"
  
  ggl_file <- "data/ggl.zip"
  
  download.file(ggl_link, ggl_file, mode="wb")
  unzip(ggl_file, exdir = "data")
  
  unlink(ggl_file)
  
  dir("data/google-political-ads-transparency-bundle", full.names =   T) %>% 
    discard(~str_detect(.x,"creative")) %>% 
    walk(file.remove)  
  
  dutch_parties <- c("D66", "VVD", "GroenLinks", "SP (Socialistische Partij)", "Volt Nederland", "Christen Democratisch Appèl", "Partij van de Arbeid")
  
  ggl_ads <- data.table::fread("data/google-political-ads-transparency-bundle/google-political-ads-creative-stats.csv") %>% 
    # filter(str_detect(Regions, "NL")) %>%
  janitor::clean_names() %>% 
  filter(advertiser_name %in% dutch_parties) %>%
  filter(date_range_start >= as.Date("2020-09-01"))
  
  return(ggl_ads)
}

ggl_ads <- get_ggl_data()

tidytemplate::save_it(ggl_ads)

  

```
```{r}

ggl_ads  %>% 
  count(date_range_start, advertiser_name) %>%
  mutate(date_range_start = as.Date(date_range_start)) %>% 
  complete(advertiser_name, date_range_start = seq.Date(min(date_range_start), max(date_range_start), by="day"), fill = list(n = 0)) %>% 
  ggplot(aes(date_range_start, n, color = advertiser_name)) +
  geom_line()
```


## Analysis / Dataviz

```{r, analysis}
ggl_ads %>% 
  count(geo_targeting_included)

heatmap_impressions <- ggl_ads %>% 
  count(date_range_start, advertiser_name, impressions) %>%
  mutate(date_range_start = as.Date(date_range_start)) %>% 
  # complete(advertiser_name, impressions, date_range_start = seq.Date(min(date_range_start), max(date_range_start), by="day"), fill = list(n = 0))%>% 
  mutate(impressions2 = fct_relevel(impressions, c("≤ 10k", "10k-100k", "100k-1M")) %>% as.numeric)

hchart(
  heatmap_impressions, 
  "bubble", 
  hcaes(
    x = date_range_start,
    y = n, 
    size = impressions2,
    group = advertiser_name
    ), 
maxSize = '10%'
  ) %>%
    hc_title(
      text = ""
    ) %>%
    hc_yAxis(
      align = "left",
      title = list(text = "Number of Ads")
    ) %>% 
    hc_xAxis(
      align = "left",
      title = list(text = "Date (daily)")
    ) %>% 
    hc_exporting(
      enabled = TRUE
    ) 

```
```{r}
ggl_ads %>% 
  mutate(gender_targeting = ifelse(str_detect(gender_targeting, "Male") & str_detect(gender_targeting, "Female"), "Not targeted", gender_targeting)) %>% 
  count(advertiser_name, gender_targeting) %>% 
  group_by(advertiser_name) %>% 
  mutate(perc = round(n/sum(n)*100, 2)) %>% 
  hchart("bar", hcaes(x = advertiser_name, y = perc, group = gender_targeting))
  
```

```{r}
ggl_ads %>% 
  # mutate(gender_targeting = ifelse(str_detect(gender_targeting, "Male") & str_detect(gender_targeting, "Female"), "Not targeted", gender_targeting)) %>% 
  mutate(age_targeting2 = case_when(
    str_detect(age_targeting, "18-24, 25-34, 35-44, 45-54, 55-64, ≥65") ~ "Not targeted",
    T ~ age_targeting
  )) %>% 
  count(advertiser_name, age_targeting2) %>% 
  complete(advertiser_name, age_targeting2, fill = list(n = 0)) %>%
  group_by(advertiser_name) %>% 
  mutate(perc = round(n/sum(n)*100, 2)) %>% 
  hchart("bar", hcaes(x = advertiser_name, y = perc, group = age_targeting2))
  
```

```{r}
ggl_ads %>% 
  mutate(geo_targeting_included = case_when(
    str_count(geo_targeting_included, ",") >= 11 ~ "Not targeted",
    str_detect(geo_targeting_included, "Netherlands") ~ "Not targeted",
    T ~ geo_targeting_included
  )) %>% 
  count(advertiser_name, geo_targeting_included) %>% 
  complete(advertiser_name, geo_targeting_included, fill = list(n = 0)) %>%
  group_by(advertiser_name) %>% 
  mutate(perc = round(n/sum(n)*100, 2)) %>% 
  hchart("bar", hcaes(x = advertiser_name, y = perc, group = geo_targeting_included))
  
 	
heatmap_impressions <- ggl_ads %>% 
  count(advertiser_name, impressions) %>%
  complete(advertiser_name, impressions, fill = list(n = 0)) %>% 
  mutate(impressions = fct_relevel(impressions, c("≤ 10k", "10k-100k", "100k-1M")))%>% 
  group_by(advertiser_name) %>% 
  mutate(perc = round(n/sum(n)*100, 2)) 

fntltp <- JS("function(){
  return this.point.x + ' ' +  this.series.yAxis.categories[this.point.y] + ': ' + this.point.value;
}")

hchart(
  heatmap_impressions, 
  "heatmap", 
  hcaes(
    x = impressions,
    y = advertiser_name, 
    value = perc
    )
  ) %>%
  hc_colorAxis(
    stops = color_stops(4, viridisLite::inferno(4, direction = -1))
  ) %>%
    hc_title(
      text = ""
    ) %>%
    hc_yAxis(
      align = "left",
      title = list(text = "Advertiser Name")
    ) %>% 
    hc_xAxis(
      align = "left",
      title = list(text = "Impressions")
    ) %>% 
    hc_exporting(
      enabled = TRUE
    ) 
```

```{r}
devtools::install_github("facebookresearch/Radlibrary")


```
```{r}
library(Radlibrary)
library(httr)

get_fb_ads <- function() {
  
token <- token_get()$token


#link to fb api
my_link<- "https://graph.facebook.com"

#define fields you are interested in
search_fields=c("ad_creation_time", 
                "ad_delivery_start_time",
                "ad_delivery_stop_time",
                "ad_creative_link_caption",
                "ad_creative_link_description",
                "ad_creative_link_title",
                "currency",
                "ad_creative_body", 
                "page_id",
                "page_name",
                "spend",
                "demographic_distribution",
                "funding_entity",
                "impressions",
                "region_distribution") %>% 
  stringr::str_c(., collapse=", ")

#get the data from the first 'page' of data the api provides
page_one_response <- GET(my_link,
                         path = "/ads_archive",
                         query = list(access_token = token,
                                      limit=100,
                                      ad_active_status="ALL",
                                      search_terms="''",
                                      impression_condition = 'HAS_IMPRESSIONS_LAST_7_DAYS',
                                      fields=search_fields,
                                      # token = token,
                                      ad_reached_countries="NL"))
page_one_content<- content(page_one_response)

x <- tibble(data=page_one_content$data)
df_imp <- x %>% 
  unnest_wider(data) 

#get the link refering to the next page
next_link <- page_one_content$paging$`next`

page <- 1

#iterate over all pages until there is no further page
while(length(next_link)>0) {
# while(T) {
  
  print(page)
  
  next_response <- GET(next_link)
  next_content<- content(next_response)
  
  y <- tibble(data=next_content$data)
  df_next <- y %>% 
    unnest_wider(data) 
  
  df_imp <- bind_rows(df_imp, df_next)  
  
  next_link <- next_content$paging$`next`
  
  page <- page + 1
  
}

dutch_parties <- c("VVD", "D66", "Forum voor Democratie -FVD", "SP", "GroenLinks", "Volt Nederland", "Partij van de Arbeid (PvdA)", "CDA", "Partij voor de Dieren", "ChristenUnie")

fb_dat <- readRDS("fb_dat/fb_dat.rds")

fb_dat <- df_imp %>% 
  bind_rows(fb_dat) %>% 
  distinct(id, .keep_all = T)

saveRDS(fb_dat, "fb_dat/fb_dat.rds")

fb_dat_parties <- fb_dat %>% 
  mutate(ad_delivery_start_time = as.Date(ad_delivery_start_time)) %>% 
  filter(ad_delivery_start_time >= as.Date("2020-09-01")) %>% 
  filter(page_name %in% dutch_parties) 

saveRDS(fb_dat_parties, "fb_dat/fb_dat_parties.rds")

return(fb_dat)

}
```


```{r}
ad_counts <- fb_dat_parties  %>% 
  count(ad_delivery_start_time, page_name) %>%
  mutate(ad_delivery_start_time = as.Date(ad_delivery_start_time)) %>% 
  complete(page_name, ad_delivery_start_time = seq.Date(min(ad_delivery_start_time), max(ad_delivery_start_time), by="day"), fill = list(n = 0))

ad_counts %>% 
  hchart("line", hcaes(x = ad_delivery_start_time, y = n, group = page_name)) %>%
    hc_title(
      text = ""
    ) %>%
    hc_yAxis(
      align = "left",
      title = list(text = "Number of Ads")
    ) %>% 
    hc_xAxis(
      align = "left",
      title = list(text = "Start Date of Ad")
    ) %>% 
    hc_exporting(
      enabled = TRUE
    ) 
```


## Conclusion